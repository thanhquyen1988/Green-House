<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ƒê·ªïi t√™n title --><title>Green Energy Game</title>
    <!-- T·∫£i Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ƒê·∫£m b·∫£o chi·ªÅu cao ƒë·∫ßy ƒë·ªß */
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Tr√°nh cu·ªôn trang */
        }
        
        #game-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* M√†n h√¨nh A (Khu v·ª±c m√¥ h√¨nh) */
        #model-a {
            background-color: #6B7280; /* Gray-500 (X√°m ƒë·∫≠m m·∫∑c ƒë·ªãnh - Khi ch∆∞a c√≥ m·∫∑t tr·ªùi) */
            background-size: cover;
            background-position: center;
            position: relative; /* Quan tr·ªçng ƒë·ªÉ ƒë·ªãnh v·ªã c√°c item con */
            transition: background-color 0.5s ease;
        }
        
        /* C·∫¨P NH·∫¨T: N·ªÅn xanh l√° khi c√≥ m·∫∑t tr·ªùi v√† kh√¥ng b·ªã che */
        #model-a.sun-present-bg {
            background-color: #D1FAE5; /* Green-100 (Xanh l√° s√°ng) */
        }
        
        /* TH√äM M·ªöI: N·ªÅn khi m·∫∑t tr·ªùi b·ªã m√¢y che */
        #model-a.sky-partly-cloudy {
             background-color: #A3E6B4; /* Xanh l√° nh·∫°t pha x√°m (t√πy ch·ªânh) */
        }


        /* L·ªõp SVG ƒë·ªÉ v·∫Ω d√¢y d·∫´n (N·∫±m d∆∞·ªõi c√°c c√¥ng c·ª•) */
        #wire-svg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10; /* N·∫±m d∆∞·ªõi c√°c c√¥ng c·ª• (z-index 20) */
            pointer-events: none; /* Cho ph√©p click xuy√™n qua */
        }
        
        /* D√¢y t·∫°m th·ªùi khi ƒëang k√©o */
        #temp-wire {
            stroke: #FDE047; /* V√†ng s√°ng */
            stroke-width: 4;
            stroke-dasharray: 8, 8;
            fill: none;
        }
        
        /* D√¢y vƒ©nh vi·ªÖn sau khi th·∫£ */
        .permanent-wire {
            stroke: #22C55E; /* Green-500 (M√†u xanh l√°) */
            stroke-width: 5;
            fill: none;
            stroke-linecap: round;
            pointer-events: none;
        }
        
        /* CSS CHO HI·ªÜU ·ª®NG D√ÇY D·∫™N "HO·∫†T ƒê·ªòNG" (N√âT ƒê·ª®T CH·∫†Y) */
        @keyframes flow-animation {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: 20; } /* ƒêi·ªÅu ch·ªânh t·ªëc ƒë·ªô ch·∫°y */
        }
        
        /* M√†u v√†ng cam m·∫∑c ƒë·ªãnh cho d√¢y active (ngu·ªìn) */
        .permanent-wire.wire-active {
            stroke: #F59E0B; /* M√†u v√†ng cam */
            stroke-dasharray: 10, 10; /* N√©t ƒë·ª©t */
            /* Animation m·∫∑c ƒë·ªãnh ch·∫°y t·ª´ END v·ªÅ START */
            animation: flow-animation 1s linear infinite;
        }
        
        /* C·∫¨P NH·∫¨T: M√†u ƒë·ªè cho d√¢y ƒë√®n active */
        .permanent-wire.light-wire-active {
             stroke: #EF4444; /* Red-500 */
        }
        
        /* ƒê·∫£o ng∆∞·ª£c h∆∞·ªõng ch·∫°y (th√†nh START v·ªÅ END) */
        .permanent-wire.wire-active.wire-reversed {
            animation-direction: reverse;
        }
        
        /* M√†n h√¨nh B (H·ªôp c√¥ng c·ª•) */
        #tools-b {
            background-color: #78350F; /* M√†u g·ªó t·ªëi (yellow-800) */
            border-left: 8px solid #451A03; /* Vi·ªÅn ƒë·∫≠m h∆°n */
            box-shadow: -10px 0 20px rgba(0,0,0,0.3) inset;
        }

        /* √î ch·ª©a c√¥ng c·ª• */
        .tool-cell {
            background-color: #92400E; /* M√†u g·ªó s√°ng h∆°n (yellow-700) */
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2) inset;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative; /* C·∫ßn cho d·∫•u c·∫•m */
        }
        
        /* CSS cho ch·∫ø ƒë·ªô D√¢y d·∫´n */
        body.wiring-mode {
            cursor: crosshair; /* H√¨nh d·∫•u + */
        }

        /* √î c√¥ng c·ª• khi ƒë∆∞·ª£c ch·ªçn (D√¢y d·∫´n) */
        .tool-cell.active-tool {
            background-color: #34D399; /* Green-400 */
            box-shadow: 0 0 15px #10B981 inset; /* Hi·ªáu ·ª©ng ph√°t s√°ng */
        }

        /* C√¥ng c·ª• (trong h·ªôp) */
        .tool-item {
            width: 80px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: grab;
            transition: transform 0.2s ease;
            font-size: 50px; /* K√≠ch th∆∞·ªõc cho Emoji */
            position: relative; /* C·∫ßn cho d·∫•u c·∫•m */
        }
        
        .tool-item:hover {
            transform: scale(1.1);
        }
        
        .tool-item .svg-icon {
            width: 100%;
            height: 100%;
        }

        /* TH√äM M·ªöI: D·∫•u c·∫•m cho c√¥ng c·ª• ƒë√£ d√πng */
        .tool-item.tool-prohibited {
            cursor: not-allowed; /* ƒê·ªïi con tr·ªè */
            opacity: 0.6; /* L√†m m·ªù ƒëi */
        }
        .tool-item.tool-prohibited::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20px;
            height: 20px;
            background-color: #EF4444; /* Red-500 */
            border-radius: 50%;
            border: 2px solid white;
            z-index: 1; /* N·∫±m tr√™n c√¥ng c·ª• */
        }
         .tool-item.tool-prohibited::after {
            content: '';
            position: absolute;
            top: 13px; /* ƒêi·ªÅu ch·ªânh v·ªã tr√≠ g·∫°ch ch√©o */
            left: 7px;
            width: 16px;
            height: 4px; /* ƒê·ªô d√†y g·∫°ch ch√©o */
            background-color: white;
            transform: rotate(45deg);
            z-index: 2; /* N·∫±m tr√™n v√≤ng tr√≤n */
        }


        /* C√¥ng c·ª• ƒë√£ ƒë∆∞·ª£c th·∫£ (tr√™n m√†n h√¨nh A) */
        .cloned-item {
            position: absolute;
            z-index: 20;
            width: 80px;
            height: 80px;
            font-size: 50px;
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Th√™m transition ƒë·ªÉ di chuy·ªÉn m∆∞·ª£t m√† khi "snap" */
            transition: left 0.3s ease, top 0.3s ease;
        }
        
        .cloned-item .svg-icon {
            width: 100%;
            height: 100%;
        }
        
        .cloned-item:active {
            cursor: grabbing;
            transition: none; /* T·∫Øt transition khi ƒëang k√©o */
        }

        /* Tr·∫°ng th√°i khi ƒëang k√©o (c·∫£ b·∫£n sao v√† b·∫£n g·ªëc) */
        .dragging {
            position: absolute; /* Ph·∫£i l√† absolute ƒë·ªÉ di chuy·ªÉn t·ª± do */
            z-index: 1000; /* Lu√¥n n·ªïi l√™n tr√™n c√πng */
            pointer-events: none; /* Kh√¥ng c·∫£n tr·ªü s·ª± ki·ªán mouseup */
            opacity: 0.9;
            transition: none; /* T·∫Øt transition khi ƒëang k√©o */
        }

        /* CSS CHO ANIMATION QUAY */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ƒê·∫∑t t√¢m quay cho c√°c c√°nh qu·∫°t (d·ª±a tr√™n viewBox 100x100, t√¢m ·ªü 50, 35) */
        .turbine-blades {
            transform-origin: 50% 35%;
        }

        /* √Åp d·ª•ng animation khi item c√≥ class 'spinning' */
        .cloned-item.spinning .turbine-blades {
            animation: spin 2s linear infinite;
        }
        
        /* === CSS PIN M·∫∂T TR·ªúI === */
        
        /* Ki·ªÉu cell pin m·∫∑t tr·ªùi (m√†u xanh d∆∞∆°ng ƒë·∫≠m) */
        .solar-cell {
            fill: #1E3A8A; /* blue-900 (Xanh d∆∞∆°ng ƒë·∫≠m) */
            transition: fill 0.2s ease;
        }

        /* Animation nh·∫•p nh√°y V√†ng <-> Xanh */
        @keyframes solar-blink {
            0%, 100% { fill: #1E3A8A; } /* Xanh d∆∞∆°ng ƒë·∫≠m */
            50% { fill: #F59E0B; }      /* V√†ng cam (gi·ªëng m√†u d√¢y) */
        }

        /* Khi m·∫∑t tr·ªùi active, √°p d·ª•ng animation cho c√°c cell */
        .cloned-item.solar-active .solar-cell {
            /* step-end gi√∫p animation "nh·∫£y" m√†u, kh√¥ng b·ªã m·ªù */
            animation: solar-blink 1s infinite step-end;
        }

        /* T·∫°o hi·ªáu ·ª©ng "t·ª± do" (nh·∫•p nh√°y ng·∫´u nhi√™n) b·∫±ng c√°ch delay kh√°c nhau */
        .cloned-item.solar-active .solar-cell:nth-child(3n+1) {
            animation-delay: -0.2s;
        }
        .cloned-item.solar-active .solar-cell:nth-child(3n+2) {
            animation-delay: -0.5s;
        }
        .cloned-item.solar-active .solar-cell:nth-child(3n+3) {
            animation-delay: -0.8s;
        }

        /* === CSS B√ìNG ƒê√àN V√Ä C√îNG T·∫ÆC === */
        
        /* Ph·∫ßn th·ªßy tinh c·ªßa b√≥ng ƒë√®n (m·∫∑c ƒë·ªãnh m√†u x√°m) */
        .bulb-glass {
            fill: #6B7280; /* Gray-500 */
            transition: fill 0.3s ease;
        }
        
        /* Khi ƒë√®n b·∫≠t, chuy·ªÉn m√†u v√†ng */
        .cloned-item.bulb-on .bulb-glass {
            fill: #FDE047; /* Yellow-300 */
            /* Th√™m hi·ªáu ·ª©ng ph√°t s√°ng nh·∫π */
            filter: drop-shadow(0 0 10px #FDE047);
        }

        /* C·∫ßn g·∫°t c√¥ng t·∫Øc (m·∫∑c ƒë·ªãnh T·∫ÆT - ƒê·ªè, V·ªã tr√≠ d∆∞·ªõi) */
        .switch-lever {
            fill: #EF4444; /* Red-500 */
            transition: fill 0.2s ease, y 0.2s ease;
            /* y="45" ƒë∆∞·ª£c ƒë·∫∑t trong SVG */
        }

        /* Khi c√¥ng t·∫Øc B·∫¨T (th√™m class .switch-on) */
        .cloned-item.switch-on .switch-lever {
            fill: #22C55E; /* Green-500 */
            /* Di chuy·ªÉn c·∫ßn g·∫°t l√™n tr√™n (thay ƒë·ªïi thu·ªôc t√≠nh y) */
            animation: switch-on-anim 0.2s forwards;
        }
        
        /* C·∫ßn animation ƒë·ªÉ thay ƒë·ªïi 'y' v√¨ n√≥ l√† thu·ªôc t√≠nh SVG, kh√¥ng ph·∫£i CSS */
        @keyframes switch-on-anim {
            from { y: 45; }
            to { y: 25; }
        }
        
        /* Ch·ªØ (c·∫£ ON v√† OFF) */
        .switch-text {
            font-size: 14px;
            font-weight: bold;
            font-family: Arial, sans-serif;
            text-anchor: middle;
            user-select: none; /* Kh√¥ng cho ph√©p ch·ªçn ch·ªØ */
        }

        /* Ch·ªØ OFF (ƒê·ªè, ·ªü tr√™n, m·∫∑c ƒë·ªãnh B·∫≠t) */
        .switch-text-off {
            fill: #EF4444;
            display: block;
        }

        /* Ch·ªØ ON (Xanh, ·ªü d∆∞·ªõi, m·∫∑c ƒë·ªãnh T·∫Øt) */
        .switch-text-on {
            fill: #22C55E;
            display: none;
        }

        /* Khi B·∫¨T, hi·ªán ch·ªØ ON, ·∫©n ch·ªØ OFF */
        .cloned-item.switch-on .switch-text-on {
            display: block;
        }
        .cloned-item.switch-on .switch-text-off {
            display: none;
        }

        /* B·∫£ng t√™n T·ªß ƒëi·ªán */
        .power-box-label {
            font-size: 8px; /* K√≠ch th∆∞·ªõc nh·ªè */
            font-weight: bold;
            font-family: Arial, sans-serif;
            fill: #FFFFFF; /* M√†u tr·∫Øng */
            text-anchor: middle;
            user-select: none;
        }


    </style>
</head>
<body class="bg-blue-100 h-screen w-screen">

    <div id="game-container">
        
        <!-- M√ÄN H√åNH A (M√î H√åNH) --><div id="model-a" class="w-4/5 h-full">
            <!-- L·ªõp SVG ƒë·ªÉ v·∫Ω d√¢y d·∫´n --><svg id="wire-svg-layer"></svg>
            <!-- C√°c c√¥ng c·ª• ƒë∆∞·ª£c th·∫£ v√†o ƒë√¢y --></div>

        <!-- M√ÄN H√åNH B (H·ªòP C√îNG C·ª§) --><div id="tools-b" class="w-1/5 h-full p-4 grid grid-cols-2 gap-4 overflow-y-auto">
            
            <!-- H√†ng 1 --><div class="tool-cell">
                <div class="tool-item" data-tool="sun" title="M·∫∑t tr·ªùi">‚òÄÔ∏è</div>
            </div>
            <div class="tool-cell">
                <!-- C√¥ng c·ª• 2: Ng√¥i nh√† (SVG) --><div class="tool-item" data-tool="house" title="Ng√¥i nh√†">
                    <svg class="svg-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <!-- M√°i nh√† (l·ªõn, m√†u ƒë·ªè) --><path d="M 5 40 L 50 10 L 95 40 Z" fill="#DC2626" stroke="#451A03" stroke-width="2"/>
                        <!-- Th√¢n nh√† (m√†u v√†ng) --><rect x="15" y="40" width="70" height="55" fill="#FBBF24" stroke="#451A03" stroke-width="2"/>
                        <!-- C·ª≠a --><rect id="house-door" x="40" y="60" width="20" height="35" fill="#78350F" stroke="#451A03" stroke-width="2"/>
                    </svg>
                </div>
            </div>

            <!-- H√†ng 2 --><div class="tool-cell">
                <!-- C√îNG C·ª§ 3: PIN M·∫∂T TR·ªúI (C·∫¨P NH·∫¨T) -->
                <div class="tool-item" data-tool="solar-panel" title="Pin m·∫∑t tr·ªùi">
                    <svg class="svg-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <g transform="skewX(-20) translate(15 0)">
                            <!-- Khung ngo√†i (m√†u s·∫´m) -->
                            <rect x="10" y="25" width="70" height="50" fill="#064E3B" stroke="#064E3B" stroke-width="2" />
                            
                            <!-- L∆∞·ªõi 3x4 (12 cell) -->
                            <g>
                                <!-- H√†ng 1 -->
                                <rect class="solar-cell" x="10.5" y="25.5" width="22.6" height="11.75"/>
                                <rect class="solar-cell" x="33.6" y="25.5" width="22.6" height="11.75"/>
                                <rect class="solar-cell" x="56.9" y="25.5" width="22.6" height="11.75"/>
                                <!-- H√†ng 2 -->
                                <rect class="solar-cell" x="10.5" y="37.75" width="22.6" height="11.75"/>
                                <rect class="solar-cell" x="33.6" y="37.75" width="22.6" height="11.75"/>
                                <rect class="solar-cell" x="56.9" y="37.75" width="22.6" height="11.75"/>
                                <!-- H√†ng 3 -->
                                <rect class="solar-cell" x="10.5" y="50" width="22.6" height="11.75"/>
                                <rect class="solar-cell" x="33.6" y="50" width="22.6" height="11.75"/>
                                <rect class="solar-cell" x="56.9" y="50" width="22.6" height="11.75"/>
                                <!-- H√†ng 4 -->
                                <rect class="solar-cell" x="10.5" y="62.25" width="22.6" height="11.75"/>
                                <rect class="solar-cell" x="33.6" y="62.25" width="22.6" height="11.75"/>
                                <rect class="solar-cell" x="56.9" y="62.25" width="22.6" height="11.75"/>
                            </g>
                            
                            <!-- ƒê∆∞·ªùng k·∫ª l∆∞·ªõi m√†u tr·∫Øng -->
                            <g stroke="#FFF" stroke-width="0.75">
                                <!-- D·ªçc -->
                                <line x1="33.35" y1="25" x2="33.35" y2="75" />
                                <line x1="56.65" y1="25" x2="56.65" y2="75" />
                                <!-- Ngang -->
                                <line x1="10" y1="37.5" x2="80" y2="37.5" />
                                <line x1="10" y1="50" x2="80" y2="50" />
                                <line x1="10" y1="62.5" x2="80" y2="62.5" />
                            </g>
                        </g>
                    </svg>
                </div>
            </div>
            <div class="tool-cell">
                <!-- C√¥ng c·ª• 4: Tua-bin gi√≥ (SVG 3 c√°nh qu·∫°t) --><div class="tool-item" data-tool="wind-turbine" title="Tua-bin gi√≥">
		    	<svg class="svg-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
		            <!-- Tr·ª• --><path d="M48 40 L48 95 Q 48 100 45 100 L 55 100 Q 52 100 52 95 L 52 40 Z" fill="#9CA3AF"/>
		            <!-- Nh√≥m c√°nh qu·∫°t (ƒë·ªÉ xoay) --><g class="turbine-blades">
		            <!-- C√°nh 1 --><path d="M 50 35 L 65 20 L 70 25 L 55 40 Z" fill="#F3F4F6" stroke="#9CA3AF" stroke-width="1.5" transform="rotate(0 50 35)"/>
            		    <!-- C√°nh 2 --><path d="M 50 35 L 65 20 L 70 25 L 55 40 Z" fill="#F3F4F6" stroke="#9CA3AF" stroke-width="1.5" transform="rotate(120 50 35)"/>
            		    <!-- C√°nh 3 --><path d="M 50 35 L 65 20 L 70 25 L 55 40 Z" fill="#F3F4F6" stroke="#9CA3AF" stroke-width="1.5" transform="rotate(240 50 35)"/>
        		</g>
        		<!-- T√¢m --><circle cx="50" cy="35" r="7" fill="#6B7280" stroke="#4B5563" stroke-width="2"/>
    		    </svg>
		</div>
            </div>

            <!-- H√†ng 3 --><div class="tool-cell">
                <!-- C√îNG C·ª§ 5: C√îNG T·∫ÆC (C·∫¨P NH·∫¨T) -->
                <div class="tool-item" data-tool="switch" title="C√¥ng t·∫Øc">
                    <svg class="svg-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <rect x="20" y="20" width="60" height="60" rx="10" fill="#E5E7EB" stroke="#4B5563" stroke-width="3"/>
                        
                        <!-- Ch·ªØ OFF (·ªü tr√™n) -->
                        <text x="50" y="38" class="switch-text switch-text-off">OFF</text>
                        
                        <!-- C·∫ßn g·∫°t (V·ªã tr√≠ Y ƒë∆∞·ª£c ƒëi·ªÅu khi·ªÉn b·∫±ng CSS) -->
                        <rect class="switch-lever" x="40" y="45" width="20" height="30" rx="5"/>

                        <!-- Ch·ªØ ON (·ªü d∆∞·ªõi) -->
                        <text x="50" y="70" class="switch-text switch-text-on">ON</text>
                    </svg>
                </div>
            </div>
            <div class="tool-cell">
                <!-- C√îNG C·ª§ 6: B√ìNG ƒê√àN (C·∫¨P NH·∫¨T) -->
                <div class="tool-item" data-tool="light-bulb" title="B√≥ng ƒë√®n">
                    <svg class="svg-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                         <!-- ƒêu√¥i ƒë√®n -->
                        <rect x="35" y="60" width="30" height="20" fill="#9CA3AF" stroke="#4B5563" stroke-width="2"/>
                        <rect x="38" y="80" width="24" height="5" fill="#6B7280"/>
                         <!-- Ph·∫ßn th·ªßy tinh (T·∫ÆT, m√†u x√°m) -->
                        <circle class="bulb-glass" cx="50" cy="40" r="30" stroke="#4B5563" stroke-width="2"/>
                    </svg>
                </div>
            </div>
            
            <!-- H√†ng 4 --><div class="tool-cell">
                <!-- C√¥ng c·ª• 7: T·ªß ƒëi·ªán (C·∫¨P NH·∫¨T: Th√™m b·∫£ng t√™n) --><div class="tool-item" data-tool="power-box" title="T·ªß ƒëi·ªán">
                    <svg class="svg-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <rect x="20" y="15" width="60" height="70" rx="8" fill="#6B7280" stroke="#374151" stroke-width="3"/>
                        <rect x="28" y="25" width="44" height="50" rx="4" fill="#D1D5DB" stroke="#4B5563" stroke-width="2"/>
                        <circle cx="38" cy="50" r="5" fill="#EF4444"/>
                        <circle cx="62" cy="50" r="5" fill="#22C55E"/>
                        <!-- B·∫£ng t√™n -->
                        <text x="50" y="80" class="power-box-label">T·ªß ƒëi·ªán</text>
                    </svg>
                </div>
            </div>
            <div class="tool-cell" id="wire-tool-cell">
                <!-- C√¥ng c·ª• 8: D√¢y d·∫´n ƒëi·ªán (SVG) - N√∫t k√≠ch ho·∫°t ch·∫ø ƒë·ªô --><div class="tool-item" data-tool="wire" title="D√¢y d·∫´n ƒëi·ªán">
                    <svg class="svg-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <path d="M 20 20 Q 50 80 80 80" stroke="#F59E0B" stroke-width="8" fill="none" stroke-linecap="round"/>
                        <circle cx="20" cy="20" r="10" fill="#3B82F6"/>
                        <circle cx="80" cy="80" r="10" fill="#3B82F6"/>
                    </svg>
                </div>
            </div>
            
            <!-- H√†ng 5 --><div class="tool-cell">
                <div class="tool-item" data-tool="cloud" title="ƒê√°m m√¢y">‚òÅÔ∏è</div>
            </div>
            <div class="tool-cell">
                <div class="tool-item" data-tool="wind" title="Lu·ªìng gi√≥ th·ªïi">üí®</div>
            </div>

            <!-- H√†ng 6 (Tr·ªëng) --><div class="tool-cell"></div>
            <div class="tool-cell"></div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('model-a');
        const toolBox = document.getElementById('tools-b');
        const wireToolCell = document.getElementById('wire-tool-cell');
        const wireLayer = document.getElementById('wire-svg-layer');

        let draggedItem = null;      
        let draggedItemCopy = null; 
        let offsetX, offsetY;
        
        // S·ª¨A L·ªñI CLICK C√îNG T·∫ÆC: Bi·∫øn theo d√µi tr·∫°ng th√°i k√©o
        let isDragging = false; // Theo d√µi n·∫øu ƒëang k√©o (k·ªÉ c·∫£ clone ho·∫∑c move)
        let isPotentialDrag = false; // Theo d√µi n·∫øu nh·∫•n chu·ªôt (c√≥ th·ªÉ l√† click ho·∫∑c drag)
        
        let isWiringMode = false; 

        // WIRING VARIABLES
        let wiringStartItem = null;
        let tempWire = null;
        // Danh s√°ch c√°c c√¥ng c·ª• c√≥ th·ªÉ tham gia n·ªëi d√¢y
        const wiringParticipants = ['power-box', 'solar-panel', 'wind-turbine', 'light-bulb', 'switch'];
        // DANH S√ÅCH C√îNG C·ª§ ƒê·ªòC QUY·ªÄN (tr·ª´ M√¢y v√† D√¢y)
        const exclusiveTools = ['sun', 'house', 'solar-panel', 'wind-turbine', 'switch', 'light-bulb', 'power-box', 'wind'];
        
        // BI·∫æN TR·∫†NG TH√ÅI TO√ÄN C·ª§C (QUAN TR·ªåNG)
        let isSunnyGlobal = false; // Tr·∫°ng th√°i C√ì N·∫ÆNG (M·∫∑t tr·ªùi c√≥ V√Ä kh√¥ng b·ªã che)


        
        // === H√ÄM H·ªñ TR·ª¢ ===
        function generateUUID() {
            return 'item-' + Date.now() + '-' + Math.random().toString(16).slice(2);
        }

        // L·∫•y t·ªça ƒë·ªô chu·ªôt t∆∞∆°ng ƒë·ªëi v·ªõi dropZone
        function getMousePos(evt) {
            const rect = dropZone.getBoundingClientRect();
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }
        
        // L·∫•y t·ªça ƒë·ªô t√¢m c·ªßa m·ªôt c√¥ng c·ª• (t∆∞∆°ng ƒë·ªëi v·ªõi dropZone)
        function getCenter(element) {
            const rect = element.getBoundingClientRect();
            const dropZoneRect = dropZone.getBoundingClientRect();
            // Tr·∫£ v·ªÅ trung t√¢m h√¨nh h·ªçc
            return {
                x: (rect.left + rect.right) /2 - dropZoneRect.left,
                y: (rect.top + rect.bottom) / 2 - dropZoneRect.top
            };
        }
        
        // L·∫•y t·ªça ƒë·ªô ƒëi·ªÉm n·ªëi ·ªü ƒë√°y (t∆∞∆°ng ƒë·ªëi v·ªõi dropZone)
        function getBottomCenter(element) {
            const rect = element.getBoundingClientRect();
            const dropZoneRect = dropZone.getBoundingClientRect();
            // Tr·∫£ v·ªÅ trung t√¢m x, c·∫°nh ƒë√°y y
            return {
                x: (rect.left + rect.right) / 2 - dropZoneRect.left,
                y: rect.bottom - dropZoneRect.top 
            };
        }

        // L·∫•y t·ªça ƒë·ªô ƒëi·ªÉm n·ªëi ·ªü ƒë·ªânh (t∆∞∆°ng ƒë·ªëi v·ªõi dropZone)
        function getTopCenter(element) {
            const rect = element.getBoundingClientRect();
            const dropZoneRect = dropZone.getBoundingClientRect();
            // Tr·∫£ v·ªÅ trung t√¢m x, c·∫°nh ƒë·ªânh y
            return {
                x: (rect.left + rect.right) / 2 - dropZoneRect.left,
                y: rect.top - dropZoneRect.top 
            };
        }
        
        // L·∫•y t·ªça ƒë·ªô ƒëi·ªÉm n·ªëi ·ªü c·∫°nh b√™n g·∫ßn nh·∫•t (t∆∞∆°ng ƒë·ªëi v·ªõi dropZone)
        function getClosestSideCenter(element, targetElement) {
            const rect = element.getBoundingClientRect();
            const dropZoneRect = dropZone.getBoundingClientRect();
            const targetCenter = getCenter(targetElement);
            const elementCenter = getCenter(element);

            let xPos;
            
            // N·∫øu element (Item) n·∫±m b√™n tr√°i target (PBox), d√πng c·∫°nh ph·∫£i c·ªßa Item.
            if (elementCenter.x < targetCenter.x) {
                xPos = rect.right - dropZoneRect.left;
            } else {
                // N·∫øu element (Item) n·∫±m b√™n ph·∫£i target (PBox), d√πng c·∫°nh tr√°i c·ªßa Item.
                xPos = rect.left - dropZoneRect.left;
            }
            
            // Tr·∫£ v·ªÅ trung t√¢m y, c·∫°nh x g·∫ßn nh·∫•t
            return {
                x: xPos,
                y: elementCenter.y
            };
        }
        
        // H√ÄM H·ªñ TR·ª¢ T√çNH TO√ÅN OVERLAP (AABB)
        function getOverlap(rect1, rect2) {
            const overlapLeft = Math.max(rect1.left, rect2.left);
            const overlapRight = Math.min(rect1.right, rect2.right);
            const overlapTop = Math.max(rect1.top, rect2.top);
            const overlapBottom = Math.min(rect1.bottom, rect2.bottom);

            if (overlapRight > overlapLeft && overlapBottom > overlapTop) {
                return (overlapRight - overlapLeft) * (overlapBottom - overlapTop);
            }
            return 0; // No overlap
        }


        // === H√ÄM QU·∫¢N L√ù D√ÇY D·∫™N ===

        /**
         * X√≥a t·∫•t c·∫£ c√°c d√¢y d·∫´n ƒë∆∞·ª£c n·ªëi v·ªõi m·ªôt c√¥ng c·ª• (d·ª±a tr√™n itemId)
         * @param {string} itemId ID c·ªßa c√¥ng c·ª• b·ªã x√≥a.
         */
        function removeWires(itemId) {
            const wires = Array.from(wireLayer.querySelectorAll('.permanent-wire'));
            wires.forEach(wire => {
                if (wire.dataset.startId === itemId || wire.dataset.endId === itemId) {
                    wire.remove();
                }
            });
        }
        
        /**
         * KI·ªÇM TRA XEM C√îNG T·∫ÆC/ƒê√àN C√ì ƒê∆Ø·ª¢C N·ªêI D√ÇY KH√îNG
         */
        function isItemWired(item) {
            if (!item) return false;
            const itemId = item.dataset.itemId;
            const wire = wireLayer.querySelector(`.permanent-wire[data-start-id="${itemId}"], .permanent-wire[data-end-id="${itemId}"]`);
            return !!wire; // Tr·∫£ v·ªÅ true n·∫øu t√¨m th·∫•y d√¢y, ng∆∞·ª£c l·∫°i false
        }

        /**
         * T√≠nh to√°n ƒë∆∞·ªùng ƒëi (path D) cho d√¢y d·∫´n d·ª±a tr√™n lo·∫°i c√¥ng c·ª•
         * @param {Element} startEl 
         * @param {Element} endEl 
         * @returns {string} Chu·ªói d c·ªßa SVG path
         */
        function calculateWirePath(startEl, endEl) {
            // Th√™m ki·ªÉm tra null ph√≤ng tr∆∞·ªùng h·ª£p 1 trong 2 b·ªã thi·∫øu
            if (!startEl || !endEl) return ""; 

            const startType = startEl.dataset.tool;
            const endType = endEl.dataset.tool;
            let pathD;

            // KI·ªÇM TRA K·∫æT N·ªêI ƒê·∫∂C BI·ªÜT
            const isTurbineConnection = (startType === 'power-box' && endType === 'wind-turbine') || 
                                       (startType === 'wind-turbine' && endType === 'power-box');
            
            const isSolarConnection = (startType === 'power-box' && endType === 'solar-panel') || 
                                      (startType === 'solar-panel' && endType === 'power-box');
                                      
            const isSwitchConnection = (startType === 'power-box' && endType === 'switch') ||
                                       (startType === 'switch' && endType === 'power-box');
                                       
            const isLightBulbConnection = (startType === 'power-box' && endType === 'light-bulb') ||
                                          (startType === 'light-bulb' && endType === 'power-box');

            if (isTurbineConnection) {
                // LOGIC N·ªêI D√ÇY TUA-BIN G√ìC VU√îNG (T·ªß ƒëi·ªán <-> Tua-bin)
                const PBox = startType === 'power-box' ? startEl : endEl;
                const Turbine = startType === 'wind-turbine' ? startEl : endEl;
                const S = getBottomCenter(PBox); 
                const E = getBottomCenter(Turbine);
                const commonY = Math.max(S.y, E.y) + 15; // ƒêi·ªÉm chung d∆∞·ªõi "m·∫∑t ƒë·∫•t"
                pathD = `M ${S.x} ${S.y} L ${S.x} ${commonY} L ${E.x} ${commonY} L ${E.x} ${E.y}`;
                
            } else if (isSolarConnection) {
                 // LOGIC N·ªêY D√ÇY PIN M·∫∂T TR·ªúI G√ìC VU√îNG (Horizontal then Vertical)
                const PBox = startType === 'power-box' ? startEl : endEl;
                const Solar = startType === 'solar-panel' ? startEl : endEl;
                const P1 = getClosestSideCenter(Solar, PBox); // C·∫°nh b√™n Pin m·∫∑t tr·ªùi
                const P4 = getTopCenter(PBox); // ƒê·ªânh T·ªß ƒëi·ªán
                const P2 = { x: P4.x, y: P1.y }; // ƒêi·ªÉm r·∫Ω g√≥c 90 ƒë·ªô
                pathD = `M ${P1.x} ${P1.y} L ${P2.x} ${P2.y} L ${P4.x} ${P4.y}`;

            } else if (isSwitchConnection) {
                // C·∫¨P NH·∫¨T: LOGIC N·ªêI D√ÇY C√îNG T·∫ÆC (Gi·ªëng Tua-bin)
                const PBox = startType === 'power-box' ? startEl : endEl;
                const Switch = startType === 'switch' ? startEl : endEl;
                const S = getBottomCenter(PBox); 
                const E = getBottomCenter(Switch);
                const commonY = Math.max(S.y, E.y) + 15; // ƒêi·ªÉm chung d∆∞·ªõi "m·∫∑t ƒë·∫•t"
                pathD = `M ${S.x} ${S.y} L ${S.x} ${commonY} L ${E.x} ${commonY} L ${E.x} ${E.y}`;
                
            } else if (isLightBulbConnection) {
                // LOGIC N·ªêI D√ÇY B√ìNG ƒê√àN G√ìC VU√îNG (Horizontal then Vertical)
                const PBox = startType === 'power-box' ? startEl : endEl;
                const LightBulb = startType === 'light-bulb' ? startEl : endEl;
                const P1 = getBottomCenter(LightBulb); // ƒê√°y B√≥ng ƒë√®n
                const P4 = getTopCenter(PBox); // ƒê·ªânh T·ªß ƒëi·ªán
                const P2 = { x: P4.x, y: P1.y }; // ƒêi·ªÉm r·∫Ω g√≥c 90 ƒë·ªô
                pathD = `M ${P1.x} ${P1.y} L ${P2.x} ${P2.y} L ${P4.x} ${P4.y}`;

            } else {
                // LOGIC M·∫∂C ƒê·ªäNH cho c√°c k·∫øt n·ªëi kh√°c (Bezier curve)
                const startPos = getCenter(startEl);
                const endPos = getCenter(endEl);
                pathD = `M ${startPos.x} ${startPos.y} Q ${startPos.x} ${endPos.y} ${endPos.x} ${endPos.y}`;
            }
            
            return pathD;
        }

        // V·∫º D√ÇY Vƒ®NH VI·ªÑN
        function createPermanentWire(startEl, endEl) {
            const startId = startEl.dataset.itemId;
            const endId = endEl.dataset.itemId;
            
            const pathD = calculateWirePath(startEl, endEl);
            
            const wire = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            wire.setAttribute('class', 'permanent-wire');
            wire.dataset.startId = startId;
            wire.dataset.endId = endId;
            wire.setAttribute('d', pathD);
            
            wireLayer.prepend(wire); 
        }

        /**
         * C·∫≠p nh·∫≠t t·∫•t c·∫£ c√°c d√¢y d·∫´n ƒë∆∞·ª£c n·ªëi v·ªõi m·ªôt c√¥ng c·ª• ƒëang di chuy·ªÉn
         * @param {string} itemId ID c·ªßa c√¥ng c·ª• ƒëang di chuy·ªÉn
         */
        function updateConnectedWires(itemId) {
            const wires = Array.from(wireLayer.querySelectorAll('.permanent-wire'));
            const movingItem = document.querySelector(`[data-item-id="${itemId}"]`);
            if (!movingItem) return;

            wires.forEach(wire => {
                let startEl, endEl;
                
                if (wire.dataset.startId === itemId) {
                    startEl = movingItem;
                    endEl = document.querySelector(`[data-item-id="${wire.dataset.endId}"]`);
                } else if (wire.dataset.endId === itemId) {
                    startEl = document.querySelector(`[data-item-id="${wire.dataset.startId}"]`);
                    endEl = movingItem;
                } else {
                    return; // B·ªè qua n·∫øu d√¢y kh√¥ng li√™n quan
                }

                if (startEl && endEl) {
                    const newPathD = calculateWirePath(startEl, endEl);
                    wire.setAttribute('d', newPathD);
                }
            });
        }
        
        // === H√ÄM QU·∫¢N L√ù TR·∫†NG TH√ÅI M√î PH·ªéNG ===
        
        /**
         * H√ÄM CH·ª¶: C·∫≠p nh·∫≠t to√†n b·ªô tr·∫°ng th√°i m√¥ ph·ªèng
         * ƒê√¢y l√† h√†m ƒëi·ªÅu khi·ªÉn ch√≠nh, g·ªçi c√°c h√†m con theo th·ª© t·ª±.
         */
        function updateAllSimulationStates() {
            // 1. C·∫≠p nh·∫≠t tr·∫°ng th√°i c√≥ n·∫Øng (M·∫∑t tr·ªùi c√≥ & kh√¥ng b·ªã che) v√† m√†u n·ªÅn
            isSunnyGlobal = checkSunAndCloudsAndUpdateBackground();
            
            // 2. C·∫≠p nh·∫≠t Pin m·∫∑t tr·ªùi (d·ª±a v√†o isSunnyGlobal)
            updateSolarPanelState(isSunnyGlobal);
            
            // 3. C·∫≠p nh·∫≠t Gi√≥ (Tua-bin quay)
            updateWindAnimation();
            
            // 4. C·∫≠p nh·∫≠t ƒê√®n (d·ª±a v√†o Pin, Gi√≥, C√¥ng t·∫Øc)
            updateLightBulbState();
            
            // 5. C·∫≠p nh·∫≠t D√¢y d·∫´n (d·ª±a v√†o Pin, Gi√≥, V√Ä TR·∫†NG TH√ÅI ƒê√àN)
            updatePowerGrid(); 
            
            // 6. C·∫≠p nh·∫≠t tr·∫°ng th√°i H·ªôp c√¥ng c·ª•
            updateToolboxAvailability();
        }
        
        /**
         * 1. Ki·ªÉm tra M·∫∑t tr·ªùi, M√¢y che, c·∫≠p nh·∫≠t n·ªÅn tr·ªùi v√† tr·∫°ng th√°i isSunnyGlobal
         * @returns {boolean} Tr·∫£ v·ªÅ true n·∫øu C√ì N·∫ÆNG (M·∫∑t tr·ªùi c√≥ V√Ä kh√¥ng b·ªã che)
         */
        function checkSunAndCloudsAndUpdateBackground() {
            const sun = document.querySelector('#model-a [data-tool="sun"]');
            const clouds = document.querySelectorAll('#model-a [data-tool="cloud"]');
            
            let isSunny = false; // M·∫∑c ƒë·ªãnh l√† kh√¥ng c√≥ n·∫Øng
            
            if (sun) {
                // C√ì c√¥ng c·ª• m·∫∑t tr·ªùi
                
                // Ki·ªÉm tra m√¢y che
                const sunRect = sun.getBoundingClientRect();
                const sunArea = (sunRect.right - sunRect.left) * (sunRect.bottom - sunRect.top);
                let totalOverlap = 0;

                clouds.forEach(cloud => {
                    const cloudRect = cloud.getBoundingClientRect();
                    totalOverlap += getOverlap(sunRect, cloudRect);
                });

                // N·∫øu kh√¥ng b·ªã che qu√° 50% -> C√ì N·∫ÆNG v√† n·ªÅn xanh l√° s√°ng
                if (totalOverlap <= (sunArea * 0.5)) {
                    isSunny = true;
                    dropZone.classList.add('sun-present-bg');
                    dropZone.classList.remove('sky-partly-cloudy');
                } else {
                    // B·ªã che -> KH√îNG c√≥ n·∫Øng v√† n·ªÅn xanh l√° pha x√°m
                    isSunny = false;
                    dropZone.classList.remove('sun-present-bg');
                    dropZone.classList.add('sky-partly-cloudy');
                }
                
            } else {
                // KH√îNG c√≥ c√¥ng c·ª• m·∫∑t tr·ªùi -> N·ªÅn x√°m ƒë·∫≠m (m·∫∑c ƒë·ªãnh) v√† kh√¥ng c√≥ n·∫Øng
                dropZone.classList.remove('sun-present-bg');
                dropZone.classList.remove('sky-partly-cloudy');
                isSunny = false; // Kh√¥ng c√≥ n·∫Øng
            }
            
            return isSunny; // Tr·∫£ v·ªÅ tr·∫°ng th√°i c√≥ n·∫Øng
        }
        
        /**
         * 2. C·∫≠p nh·∫≠t tr·∫°ng th√°i Pin m·∫∑t tr·ªùi (nh·∫•p nh√°y)
         * @param {boolean} isSunny Tr·∫°ng th√°i c√≥ n·∫Øng (ƒë√£ t√≠nh to√°n)
         */
        function updateSolarPanelState(isSunny) {
            const solarPanels = document.querySelectorAll('#model-a [data-tool="solar-panel"]');

            solarPanels.forEach(panel => {
                // Pin ch·ªâ active khi C√ì N·∫ÆNG
                if (isSunny) {
                    panel.classList.add('solar-active');
                } else {
                    panel.classList.remove('solar-active');
                }
            });
            
            // updatePowerGrid(); // S·∫Ω ƒë∆∞·ª£c g·ªçi trong h√†m updateAllSimulationStates
        }

        /**
         * 3. C·∫¨P NH·∫¨T ANIMATION GI√ì
         */
        function updateWindAnimation() {
            const windIsPresent = !!document.querySelector('#model-a [data-tool="wind"]');
            const turbines = document.querySelectorAll('#model-a [data-tool="wind-turbine"]');

            turbines.forEach(turbine => {
                if (windIsPresent) {
                    turbine.classList.add('spinning');
                } else {
                    turbine.classList.remove('spinning');
                }
            });
            
            // updatePowerGrid(); // S·∫Ω ƒë∆∞·ª£c g·ªçi trong h√†m updateAllSimulationStates
        }
        
        /**
         * 4. C·∫≠p nh·∫≠t tr·∫°ng th√°i B√≥ng ƒë√®n (B·∫≠t/T·∫Øt)
         */
        function updateLightBulbState() {
            const lightBulbs = document.querySelectorAll('#model-a [data-tool="light-bulb"]');
            if (lightBulbs.length === 0) return; // Kh√¥ng c√≥ ƒë√®n, b·ªè qua

            // C·∫¨P NH·∫¨T LOGIC: Ki·ªÉm tra ngu·ªìn C√ì D√ÇY
            const turbineEl = document.querySelector('#model-a [data-tool="wind-turbine"]');
            const solarPanelEl = document.querySelector('#model-a [data-tool="solar-panel"]');
            
            const isWiredTurbineSpinning = turbineEl && turbineEl.classList.contains('spinning') && isItemWired(turbineEl);
            const isWiredSolarActive = isSunnyGlobal && solarPanelEl && isItemWired(solarPanelEl);
            
            const isPowerAvailable = isWiredTurbineSpinning || isWiredSolarActive;

            // Ki·ªÉm tra c√¥ng t·∫Øc
            const mainSwitch = document.querySelector('#model-a [data-tool="switch"]');
            
            let isLightOn = false;
            
            // Logic ƒë√®n s√°ng
            if (mainSwitch) {
                // C√ì C√îNG T·∫ÆC: ƒê√®n s√°ng = Ngu·ªìn C√ì D√ÇY V√Ä C√¥ng t·∫Øc B·∫¨T V√Ä C√¥ng t·∫Øc C√ì D√ÇY
                if (isPowerAvailable && 
                    mainSwitch.classList.contains('switch-on') &&
                    isItemWired(mainSwitch) ) { 
                    
                    isLightOn = true; 
                }
            } else {
                // KH√îNG C√ì C√îNG T·∫ÆC: ƒê√®n s√°ng = Ngu·ªìn C√ì D√ÇY
                if (isPowerAvailable) {
                    isLightOn = true;
                }
            }

            // √Åp d·ª•ng tr·∫°ng th√°i cho t·∫•t c·∫£ b√≥ng ƒë√®n (V√Ä KI·ªÇM TRA D√ÇY C·ª¶A ƒê√àN)
            lightBulbs.forEach(bulb => {
                // ƒê√®n ch·ªâ s√°ng n·∫øu (isLightOn (ƒë√£ check ngu·ªìn/c√¥ng t·∫Øc/d√¢y ngu·ªìn) V√Ä ch√≠nh n√≥ (b√≥ng ƒë√®n) C√ì D√ÇY)
                if (isLightOn && isItemWired(bulb)) {
                    bulb.classList.add('bulb-on');
                } else {
                    bulb.classList.remove('bulb-on');
                }
            });
        }
        
        /**
         * 5. C·∫≠p nh·∫≠t tr·∫°ng th√°i "ho·∫°t ƒë·ªông" (n√©t ƒë·ª©t) c·ªßa d√¢y d·∫´n
         */
        function updatePowerGrid() {
            const powerBox = document.querySelector('#model-a [data-tool="power-box"]');
            const isSunny = isSunnyGlobal; 

            if (!powerBox) {
                document.querySelectorAll('.permanent-wire').forEach(w => w.classList.remove('wire-active', 'wire-reversed', 'light-wire-active'));
                return;
            }

            const powerBoxId = powerBox.dataset.itemId;
            const allWires = document.querySelectorAll('.permanent-wire');

            allWires.forEach(wire => {
                const startId = wire.dataset.startId;
                const endId = wire.dataset.endId;
                const item1 = document.querySelector(`[data-item-id="${startId}"]`);
                const item2 = document.querySelector(`[data-item-id="${endId}"]`);

                if (!item1 || !item2) {
                    wire.classList.remove('wire-active', 'wire-reversed', 'light-wire-active');
                    return;
                }

                const item1Type = item1.dataset.tool;
                const item2Type = item2.dataset.tool;

                let isActive = false;
                 // S·ª¨A L·ªñI HI·ªÜU ·ª®NG D√ÇY D·∫™N (ƒê·∫£o ng∆∞·ª£c)
                 // true = ch·∫°y START -> END (ƒë·∫£o ng∆∞·ª£c CSS), false = ch·∫°y END -> START (CSS m·∫∑c ƒë·ªãnh)
                let useReverseAnimation = false;
                let isLightWire = false;

                // Case 1: Pin -> T·ªß ho·∫∑c T·ªß -> Pin
                if ((item1Type === 'solar-panel' && item2Type === 'power-box') || 
                    (item1Type === 'power-box' && item2Type === 'solar-panel')) {
                    if (isSunny) { 
                        isActive = true;
                        // H∆∞·ªõng ch·∫°y: Pin -> T·ªß
                        useReverseAnimation = (item1Type === 'solar-panel'); // Reverse n·∫øu Pin l√† Start
                    }
                } 
                // Case 2: Tua-bin -> T·ªß ho·∫∑c T·ªß -> Tua-bin
                else if ((item1Type === 'wind-turbine' && item2Type === 'power-box') || 
                           (item1Type === 'power-box' && item2Type === 'wind-turbine')) {
                    const turbineEl = (item1Type === 'wind-turbine') ? item1 : item2;
                    if (turbineEl.classList.contains('spinning')) {
                        isActive = true;
                        // H∆∞·ªõng ch·∫°y: Tua-bin -> T·ªß
                        useReverseAnimation = (item1Type === 'wind-turbine'); // Reverse n·∫øu Tua-bin l√† Start
                    }
                }
                // Case 3: T·ªß -> ƒê√®n ho·∫∑c ƒê√®n -> T·ªß
                else if ((item1Type === 'light-bulb' && item2Type === 'power-box') || 
                           (item1Type === 'power-box' && item2Type === 'light-bulb')) {
                    const lightBulbEl = (item1Type === 'light-bulb') ? item1 : item2;
                    if (lightBulbEl.classList.contains('bulb-on')) {
                        isActive = true;
                        isLightWire = true;
                        // H∆∞·ªõng ch·∫°y: T·ªß -> ƒê√®n
                        useReverseAnimation = (item1Type === 'power-box'); // Reverse n·∫øu T·ªß l√† Start
                    }
                }

                // Apply classes
                if (isActive) {
                    wire.classList.add('wire-active');
                    if (useReverseAnimation) {
                        wire.classList.add('wire-reversed');
                    } else {
                        wire.classList.remove('wire-reversed');
                    }
                    if (isLightWire) {
                        wire.classList.add('light-wire-active');
                    } else {
                        wire.classList.remove('light-wire-active');
                    }
                } else {
                    wire.classList.remove('wire-active', 'wire-reversed', 'light-wire-active');
                }
            });
        }
        
        /**
         * 6. C·∫≠p nh·∫≠t tr·∫°ng th√°i H·ªôp c√¥ng c·ª• (Th√™m d·∫•u c·∫•m)
         */
         function updateToolboxAvailability() {
             const toolboxItems = toolBox.querySelectorAll('.tool-item');
             toolboxItems.forEach(item => {
                 const toolType = item.dataset.tool;
                 // B·ªè qua d√¢y d·∫´n v√† ƒë√°m m√¢y
                 if (toolType === 'wire' || toolType === 'cloud') {
                     item.classList.remove('tool-prohibited'); // ƒê·∫£m b·∫£o ch√∫ng kh√¥ng bao gi·ªù b·ªã c·∫•m
                     return;
                 }
                 
                 // Ki·ªÉm tra xem c√¥ng c·ª• c√≥ t·ªìn t·∫°i tr√™n m√†n h√¨nh A kh√¥ng
                 const itemExistsOnScreen = !!dropZone.querySelector(`.cloned-item[data-tool="${toolType}"]`);
                 
                 if (itemExistsOnScreen) {
                     item.classList.add('tool-prohibited');
                 } else {
                     item.classList.remove('tool-prohibited');
                 }
             });
         }

        
        // === H√ÄM T·ª∞ ƒê·ªòNG G·∫ÆN (SNAP) ===
        
        /**
         * H√ÄM CH·ª¶ M·ªöI: G·ªçi t·∫•t c·∫£ c√°c h√†m snap
         */
        function updateAllSnapPositions() {
            // D√πng setTimeout ƒë·ªÉ ƒë·∫£m b·∫£o v·ªã tr√≠ Ng√¥i nh√† ƒë∆∞·ª£c c·∫≠p nh·∫≠t
            // tr∆∞·ªõc khi g·∫Øn c√°c v·∫≠t th·ªÉ kh√°c v√†o
            setTimeout(() => {
                snapPowerBoxToHouse();
                snapSolarPanelToHouse();
                snapSwitchToHouse(); // TH√äM M·ªöI
                snapLightBulbToHouse(); // TH√äM M·ªöI
            }, 0); // 0ms delay, ch·ªâ ƒë·ªÉ ƒë·∫©y v√†o cu·ªëi h√†ng ƒë·ª£i th·ª±c thi
        }

        /**
         * H√ÄM SNAP: T·ª± ƒë·ªông g·∫Øn T·ªß ƒëi·ªán (power-box) v√†o Ng√¥i nh√† (house)
         */
        function snapPowerBoxToHouse() {
            const house = document.querySelector('#model-a [data-tool="house"]');
            const powerBox = document.querySelector('#model-a [data-tool="power-box"]');

            // Ch·ªâ th·ª±c hi·ªán khi c·∫£ hai t·ªìn t·∫°i
            if (house && powerBox) {
                // L·∫•y k√≠ch th∆∞·ªõc v√† v·ªã tr√≠ style (ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t b·∫±ng px)
                const houseTop = parseFloat(house.style.top);
                const houseLeft = parseFloat(house.style.left);
                const houseHeight = parseFloat(house.style.height);
                
                const powerBoxHeight = parseFloat(powerBox.style.height);
                const powerBoxWidth = parseFloat(powerBox.style.width);

                // T√≠nh to√°n v·ªã tr√≠ m·ªõi
                // ƒêI·ªÄU CH·ªàNH: G·∫Øn v√†o "ch√¢n m√©p t∆∞·ªùng" (d∆∞·ªõi c√πng b√™n tr√°i)
                // ƒê·∫∑t Y: G·∫ßn ƒë√°y nh√† (houseTop + houseHeight) tr·ª´ ƒëi chi·ªÅu cao T·ªß ƒëi·ªán, v√† 1 kho·∫£ng ƒë·ªám nh·ªè (10px)
                let targetY = houseTop + houseHeight - powerBoxHeight - 10; 
                let targetX = houseLeft + 5; // ƒê·∫∑t T·ªß ƒëi·ªán c√°ch m√©p tr√°i Ng√¥i nh√† 5px (b√™n trong)

                // Gi·ªõi h·∫°n trong m√†n h√¨nh
                targetX = Math.max(0, Math.min(targetX, dropZone.clientWidth - powerBoxWidth));
                targetY = Math.max(0, Math.min(targetY, dropZone.clientHeight - powerBoxHeight));
                
                // Di chuy·ªÉn T·ªß ƒëi·ªán
                powerBox.style.left = `${targetX}px`;
                powerBox.style.top = `${targetY}px`;

                // C·∫≠p nh·∫≠t d√¢y d·∫´n c·ªßa T·ªß ƒëi·ªán sau khi n√≥ di chuy·ªÉn
                if (powerBox.dataset.itemId) {
                    setTimeout(() => {
                         updateConnectedWires(powerBox.dataset.itemId);
                    }, 300); // 300ms kh·ªõp v·ªõi 'transition' trong CSS
                }
            }
        }
        
        /**
         * H√ÄM SNAP: T·ª± ƒë·ªông g·∫Øn Pin m·∫∑t tr·ªùi (solar-panel) v√†o Ng√¥i nh√† (house)
         */
        function snapSolarPanelToHouse() {
            const house = document.querySelector('#model-a [data-tool="house"]');
            const solarPanel = document.querySelector('#model-a [data-tool="solar-panel"]');

            // Ch·ªâ th·ª±c hi·ªán khi c·∫£ hai t·ªìn t·∫°i
            if (house && solarPanel) {
                const houseTop = parseFloat(house.style.top);
                const houseLeft = parseFloat(house.style.left);
                const houseWidth = parseFloat(house.style.width);
                const houseHeight = parseFloat(house.style.height); // houseHeight is 320px
                
                const solarPanelWidth = parseFloat(solarPanel.style.width); // solarPanel width is 160px
                const solarPanelHeight = parseFloat(solarPanel.style.height); // solarPanel height is 160px

                // T√≠nh to√°n v·ªã tr√≠ m·ªõi
                // ƒê·∫∑t v√†o gi·ªØa m√°i nh√†
                // M√°i nh√† (t·ª´ 10% ƒë·∫øn 40% chi·ªÅu cao c·ªßa SVG)
                let targetX = houseLeft + (houseWidth / 2) - (solarPanelWidth / 2);
                // ƒê·∫∑t n√≥ ·ªü kho·∫£ng 15% t·ª´ ƒë·ªânh c·ªßa SVG nh√†
                let targetY = houseTop + (houseHeight * 0.15) - (solarPanelHeight / 2);

                // Gi·ªõi h·∫°n trong m√†n h√¨nh
                targetX = Math.max(0, Math.min(targetX, dropZone.clientWidth - solarPanelWidth));
                targetY = Math.max(0, Math.min(targetY, dropZone.clientHeight - solarPanelHeight));
                
                // Di chuy·ªÉn Pin m·∫∑t tr·ªùi
                solarPanel.style.left = `${targetX}px`;
                solarPanel.style.top = `${targetY}px`;

                // C·∫≠p nh·∫≠t d√¢y d·∫´n c·ªßa Pin m·∫∑t tr·ªùi sau khi n√≥ di chuy·ªÉn
                if (solarPanel.dataset.itemId) {
                    setTimeout(() => {
                         updateConnectedWires(solarPanel.dataset.itemId);
                    }, 300); // 300ms kh·ªõp v·ªõi 'transition'
                }
            }
        }
        
        /**
         * H√ÄM SNAP: T·ª± ƒë·ªông g·∫Øn C√¥ng t·∫Øc (switch) v√†o Ng√¥i nh√† (house)
         */
        function snapSwitchToHouse() {
            const house = document.querySelector('#model-a [data-tool="house"]');
            const mainSwitch = document.querySelector('#model-a [data-tool="switch"]');

            if (house && mainSwitch) {
                const houseTop = parseFloat(house.style.top);
                const houseLeft = parseFloat(house.style.left);
                const houseHeight = parseFloat(house.style.height); // 320px
                const houseWidth = parseFloat(house.style.width); // 320px

                const switchWidth = parseFloat(mainSwitch.style.width); // 80px
                const switchHeight = parseFloat(mainSwitch.style.height); // 80px
                
                // C·ª≠a (theo SVG): x="40", y="60", width="20", height="35"
                // (T·ª∑ l·ªá 0-100)
                const doorLeftRatio = 40 / 100;
                const doorTopRatio = 60 / 100;
                const doorHeightRatio = 35 / 100;
                const doorWidthRatio = 20 / 100; // Th√™m chi·ªÅu r·ªông c·ª≠a
                
                // V·ªã tr√≠ c·ª≠a (ƒë√£ scale)
                const doorLeftPx = houseLeft + (houseWidth * doorLeftRatio);
                const doorTopPx = houseTop + (houseHeight * doorTopRatio);
                const doorHeightPx = houseHeight * doorHeightRatio;
                const doorWidthPx = houseWidth * doorWidthRatio; // Th√™m chi·ªÅu r·ªông c·ª≠a
                
                // C·∫¨P NH·∫¨T: "gi·ªØa m√©p ph·∫£i c√°nh c·ª≠a"
                let targetX = doorLeftPx + doorWidthPx + 5; // 5px b√™n ph·∫£i c·ª≠a
                let targetY = doorTopPx + (doorHeightPx / 2) - (switchHeight / 2); // Gi·ªØa c·ª≠a (chi·ªÅu d·ªçc)

                // Gi·ªõi h·∫°n
                targetX = Math.max(0, Math.min(targetX, dropZone.clientWidth - switchWidth));
                targetY = Math.max(0, Math.min(targetY, dropZone.clientHeight - switchHeight));

                mainSwitch.style.left = `${targetX}px`;
                mainSwitch.style.top = `${targetY}px`;

                if (mainSwitch.dataset.itemId) {
                    setTimeout(() => {
                         updateConnectedWires(mainSwitch.dataset.itemId);
                    }, 300);
                }
            }
        }
        
        /**
         * H√ÄM SNAP: T·ª± ƒë·ªông g·∫Øn B√≥ng ƒë√®n (light-bulb) v√†o Ng√¥i nh√† (house)
         */
        function snapLightBulbToHouse() {
            const house = document.querySelector('#model-a [data-tool="house"]');
            const lightBulb = document.querySelector('#model-a [data-tool="light-bulb"]');

            if (house && lightBulb) {
                const houseTop = parseFloat(house.style.top);
                const houseLeft = parseFloat(house.style.left);
                const houseHeight = parseFloat(house.style.height); // 320px
                const houseWidth = parseFloat(house.style.width); // 320px

                const bulbWidth = parseFloat(lightBulb.style.width); // 80px
                const bulbHeight = parseFloat(lightBulb.style.height); // 80px
                
                // C·ª≠a (theo SVG): x="40", y="60", width="20"
                const doorLeftRatio = 40 / 100;
                const doorTopRatio = 60 / 100;
                const doorWidthRatio = 20 / 100;
                
                // V·ªã tr√≠ c·ª≠a (ƒë√£ scale)
                const doorLeftPx = houseLeft + (houseWidth * doorLeftRatio);
                const doorTopPx = houseTop + (houseHeight * doorTopRatio);
                const doorWidthPx = houseWidth * doorWidthRatio;

                // "ph√≠a tr√™n c√°nh c·ª≠a"
                let targetX = doorLeftPx + (doorWidthPx / 2) - (bulbWidth / 2); // Gi·ªØa c·ª≠a (chi·ªÅu ngang)
                let targetY = doorTopPx - bulbHeight - 5; // 5px ph√≠a tr√™n c·ª≠a

                // Gi·ªõi h·∫°n
                targetX = Math.max(0, Math.min(targetX, dropZone.clientWidth - bulbWidth));
                targetY = Math.max(0, Math.min(targetY, dropZone.clientHeight - bulbHeight));

                lightBulb.style.left = `${targetX}px`;
                lightBulb.style.top = `${targetY}px`;

                if (lightBulb.dataset.itemId) {
                    setTimeout(() => {
                         updateConnectedWires(lightBulb.dataset.itemId);
                    }, 300);
                }
            }
        }


        // === LOGIC T∆Ø∆†NG T√ÅC CH√çNH ===

        // 1. Nh·∫•n chu·ªôt xu·ªëng tr√™n H·ªòP C√îNG C·ª§ (M√†n h√¨nh B)
        toolBox.addEventListener('mousedown', (e) => {
            const toolItem = e.target.closest('.tool-item');
            if (!toolItem || toolItem.classList.contains('tool-prohibited')) return; // TH√äM: Kh√¥ng cho k√©o n·∫øu b·ªã c·∫•m

            e.preventDefault(); 
            isPotentialDrag = true; // B·∫Øt ƒë·∫ßu nh·∫•n chu·ªôt
            
            // KI·ªÇM TRA CH·∫æ ƒê·ªò N·ªêI D√ÇY (CLICK)
            if (toolItem.dataset.tool === 'wire') {
                isWiringMode = !isWiringMode; // Chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i
                
                if (isWiringMode) {
                    document.body.classList.add('wiring-mode');
                    wireToolCell.classList.add('active-tool');
                } else {
                    document.body.classList.remove('wiring-mode');
                    wireToolCell.classList.remove('active-tool');
                }
                isPotentialDrag = false; // ƒê√¢y l√† 1 c√∫ click, kh√¥ng ph·∫£i drag
                return; // KH√îNG TH·ª∞C HI·ªÜN K√âO TH·∫¢
            }
            
            // T·∫†O B·∫¢N SAO ƒê·ªÇ K√âO (Ch·ªâ khi KH√îNG ·ªü ch·∫ø ƒë·ªô n·ªëi d√¢y)
            if (!isWiringMode) {
                // Logic ki·ªÉm tra ƒë·ªôc quy·ªÅn ƒë√£ ƒë∆∞·ª£c d·ªùi l√™n tr√™n
            
                draggedItemCopy = toolItem.cloneNode(true); 
                draggedItemCopy.classList.add('dragging', 'cloned-item');
                draggedItemCopy.classList.remove('tool-item', 'tool-prohibited'); // X√≥a class c·∫•m kh·ªèi b·∫£n sao

                const rect = toolItem.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;

                draggedItemCopy.style.left = `${e.clientX - offsetX}px`;
                draggedItemCopy.style.top = `${e.clientY - offsetY}px`;

                document.body.appendChild(draggedItemCopy);
            }
        });
        
        // 2. NH·∫§P CHU·ªòT (CLICK) TR√äN M√ÄN H√åNH A (ƒê·ªÇ B·∫¨T/T·∫ÆT C√îNG T·∫ÆC)
        dropZone.addEventListener('click', (e) => {
            // S·ª¨A L·ªñI CLICK: Ch·ªâ x·ª≠ l√Ω click n·∫øu KH√îNG ph·∫£i l√† ƒëang k√©o/v·ª´a k√©o xong
            if (isDragging || isWiringMode || isPotentialDrag) {
                // isPotentialDrag ki·ªÉm tra n·∫øu mouseup x·∫£y ra ngay sau mousedown (l√† 1 c√∫ click)
                // nh∆∞ng n·∫øu n√≥ l√† 1 c√∫ k√©o (isDragging) th√¨ b·ªè qua
                if(isDragging) return;
            }
            
            const targetItem = e.target.closest('.cloned-item');
            if (targetItem && targetItem.dataset.tool === 'switch') {
                // B·∫≠t/t·∫Øt tr·∫°ng th√°i
                targetItem.classList.toggle('switch-on');
                
                // C·∫≠p nh·∫≠t to√†n b·ªô m√¥ ph·ªèng (ch·ªß y·∫øu l√† ƒë√®n)
                updateAllSimulationStates();
            }
        });


        // 3. Nh·∫•n chu·ªôt xu·ªëng tr√™n M√ÄN H√åNH A (ƒê·ªÇ K√âO HO·∫∂C N·ªêI D√ÇY)
        dropZone.addEventListener('mousedown', (e) => {
            isPotentialDrag = true; // B·∫Øt ƒë·∫ßu nh·∫•n chu·ªôt
            const targetItem = e.target.closest('.cloned-item');

            // TR∆Ø·ªúNG H·ª¢P 1: ƒêANG ·ªû CH·∫æ ƒê·ªò N·ªêI D√ÇY
            if (isWiringMode) {
                e.preventDefault();
                isPotentialDrag = false; // N·ªëi d√¢y kh√¥ng ph·∫£i l√† k√©o
                // Ph·∫£i c√≥ item V√Ä item ƒë√≥ l√† m·ªôt "ƒë·∫ßu n·ªëi" h·ª£p l·ªá
                if (targetItem && wiringParticipants.includes(targetItem.dataset.tool)) {
                    // B·∫Øt ƒë·∫ßu v·∫Ω d√¢y
                    wiringStartItem = targetItem;
                    const startPos = getCenter(wiringStartItem); 
                    
                    // T·∫°o d√¢y t·∫°m th·ªùi
                    tempWire = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    tempWire.setAttribute('id', 'temp-wire');
                    tempWire.setAttribute('d', `M ${startPos.x} ${startPos.y} L ${startPos.x} ${startPos.y}`);
                    wireLayer.appendChild(tempWire);
                }
                return; 
            }
            
            // TR∆Ø·ªúNG H·ª¢P 2: DI CHUY·ªÇN C√îNG C·ª§ ƒê√É C√ì
            if (targetItem) {
                // S·ª¨A L·ªñI CLICK: Ch·ªâ preventDefault N·∫æU KH√îNG PH·∫¢I L√Ä C√îNG T·∫ÆC
                // ƒë·ªÉ cho ph√©p s·ª± ki·ªán 'click' ho·∫°t ƒë·ªông
                if (targetItem.dataset.tool !== 'switch') {
                    e.preventDefault(); // NgƒÉn ch·∫∑n text selection
                }
                
                draggedItem = targetItem;
                // S·ª¨A L·ªñI CLICK: ƒê·∫∑t z-index ngay l·∫≠p t·ª©c, nh∆∞ng ch∆∞a add 'dragging'
                // 'dragging' s·∫Ω ƒë∆∞·ª£c th√™m trong 'mousemove' n·∫øu chu·ªôt th·ª±c s·ª± di chuy·ªÉn
                draggedItem.style.zIndex = 1001; 
                
                const rect = draggedItem.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
            }
        });

        // 4. DI CHUY·ªÇN CHU·ªòT (Global)
        document.addEventListener('mousemove', (e) => {
            e.preventDefault();
            
            // S·ª¨A L·ªñI CLICK: N·∫øu ƒëang nh·∫•n chu·ªôt (potentialDrag), v√† chu·ªôt di chuy·ªÉn -> x√°c nh·∫≠n l√† K√âO
            if (isPotentialDrag && (draggedItem || draggedItemCopy)) {
                // Ch·ªâ ƒë·∫∑t isDragging n·∫øu th·ª±c s·ª± di chuy·ªÉn m·ªôt kho·∫£ng nh·ªè
                if (Math.abs(e.movementX) > 1 || Math.abs(e.movementY) > 1) {
                     isDragging = true; 
                    // Th√™m class dragging khi b·∫Øt ƒë·∫ßu k√©o
                    if(draggedItem && !draggedItem.classList.contains('dragging')) draggedItem.classList.add('dragging');
                    if(draggedItemCopy && !draggedItemCopy.classList.contains('dragging')) draggedItemCopy.classList.add('dragging'); // Th√™m cho clone
                }
            }

            const mousePos = getMousePos(e);

            // A. ƒêang k√©o (di chuy·ªÉn) item
            if (draggedItem && isDragging) {
                let x = mousePos.x - offsetX;
                let y = mousePos.y - offsetY;

                x = Math.max(0, Math.min(x, dropZone.clientWidth - draggedItem.clientWidth));
                y = Math.max(0, Math.min(y, dropZone.clientHeight - draggedItem.clientHeight));
                
                draggedItem.style.left = `${x}px`;
                draggedItem.style.top = `${y}px`;

                // C·∫¨P NH·∫¨T D√ÇY D·∫™N (LU√îN LU√îN)
                if (draggedItem.dataset.itemId) {
                    updateConnectedWires(draggedItem.dataset.itemId);
                }
                
                // C·∫¨P NH·∫¨T M√ÇY CHE/M·∫∂T TR·ªúI (N·∫æU ƒêANG K√âO M√ÇY/M·∫∂T TR·ªúI)
                const toolType = draggedItem.dataset.tool;
                if (toolType === 'cloud' || toolType === 'sun') {
                    updateAllSimulationStates();
                }
            }
            // B. ƒêang k√©o (sao ch√©p) item m·ªõi
            else if (draggedItemCopy && isDragging) {
                draggedItemCopy.style.left = `${e.clientX - offsetX}px`;
                draggedItemCopy.style.top = `${e.clientY - offsetY}px`;
            }
            // C. ƒêang k√©o (n·ªëi d√¢y)
            else if (wiringStartItem && tempWire) {
                const startPos = getCenter(wiringStartItem);
                // V·∫Ω ƒë∆∞·ªùng cong m∆∞·ª£t theo v·ªã tr√≠ chu·ªôt (cho m·ª•c ƒë√≠ch xem tr∆∞·ªõc)
                tempWire.setAttribute('d', `M ${startPos.x} ${startPos.y} Q ${startPos.x} ${mousePos.y} ${mousePos.x} ${mousePos.y}`);
            }
        });

        // 5. NH·∫¢ CHU·ªòT (Global)
        document.addEventListener('mouseup', (e) => {
            const dropZoneRect = dropZone.getBoundingClientRect();
            const toolBoxRect = toolBox.getBoundingClientRect();

            const isOverDropZone = e.clientX >= dropZoneRect.left && e.clientX <= dropZoneRect.right &&
                                 e.clientY >= dropZoneRect.top && e.clientY <= dropZoneRect.bottom;
            
            const isOverToolBox = e.clientX >= toolBoxRect.left && e.clientX <= toolBoxRect.right &&
                                e.clientY >= toolBoxRect.top && e.clientY <= toolBoxRect.bottom;

            // TR∆Ø·ªúNG H·ª¢P 1: K·∫æT TH√öC N·ªêI D√ÇY
            if (isWiringMode && wiringStartItem) {
                const endItem = e.target.closest('.cloned-item');
                const startType = wiringStartItem.dataset.tool;
                const endType = endItem ? endItem.dataset.tool : null;

                // Ki·ªÉm tra m·ª•c ti√™u h·ª£p l·ªá: Ph·∫£i l√† ƒë·∫ßu n·ªëi h·ª£p l·ªá, kh√¥ng ph·∫£i ch√≠nh n√≥
                if (endItem && endItem !== wiringStartItem && wiringParticipants.includes(endType)) 
                {
                    createPermanentWire(wiringStartItem, endItem);
                    updateAllSimulationStates(); // C·∫≠p nh·∫≠t to√†n b·ªô
                }

                // Reset tr·∫°ng th√°i n·ªëi d√¢y
                if(tempWire) tempWire.remove();
                tempWire = null;
                wiringStartItem = null;
                
                // T·∫ÆT CH·∫æ ƒê·ªò N·ªêI D√ÇY V√Ä HI·ªÇN TH·ªä
                isWiringMode = false;
                document.body.classList.remove('wiring-mode');
                wireToolCell.classList.remove('active-tool');
                
                // return; // Kh√¥ng return v·ªôi, ƒë·ªÉ reset isDragging
            }
            
            // TR∆Ø·ªúNG H·ª¢P 2: TH·∫¢ C√îNG C·ª§ M·ªöI (CLONE)
            else if (draggedItemCopy) {
                draggedItemCopy.classList.remove('dragging');
                
                // Th√™m ki·ªÉm tra
                if (draggedItemCopy.parentNode === document.body) {
                    document.body.removeChild(draggedItemCopy); 
                }
                
                const newToolType = draggedItemCopy.dataset.tool;
                
                if (isOverDropZone && isDragging) { // Ch·ªâ th·∫£ n·∫øu th·ª±c s·ª± k√©o
                    const mousePos = getMousePos(e);
                    
                    let x = mousePos.x - offsetX;
                    let y = mousePos.y - offsetY;

                    // LOGIC PH√ìNG TO
                    let scaleFactor = 1;
                    if (newToolType === 'house') {
                        scaleFactor = 4;
                    } else if (newToolType === 'wind-turbine') {
                        scaleFactor = 3;
                    } else if (newToolType === 'solar-panel') { 
                        scaleFactor = 2;
                    }
                    
                    const newWidth = 80 * scaleFactor;
                    const newHeight = 80 * scaleFactor;

                    // ƒêi·ªÅu ch·ªânh v·ªã tr√≠ th·∫£ d·ª±a tr√™n k√≠ch th∆∞·ªõc m·ªõi (tr√°nh tr√†n l·ªÅ)
                    x = Math.max(0, Math.min(x, dropZone.clientWidth - newWidth));
                    y = Math.max(0, Math.min(y, dropZone.clientHeight - newHeight));
                    
                    draggedItemCopy.style.left = `${x}px`;
                    draggedItemCopy.style.top = `${y}px`;
                    draggedItemCopy.style.width = `${newWidth}px`; 
                    draggedItemCopy.style.height = `${newHeight}px`;
                    
                    // S·ª¨A ƒê·ªîI: ƒê·∫∑t z-index
                    if (newToolType === 'house') {
                        draggedItemCopy.style.zIndex = 5; // D∆∞·ªõi c√πng
                    } else if (newToolType === 'solar-panel') {
                        draggedItemCopy.style.zIndex = 8; // Tr√™n nh√†, d∆∞·ªõi d√¢y
                    } else {
                        draggedItemCopy.style.zIndex = 20; // M·∫∑c ƒë·ªãnh
                    }

                    // G√°n ID duy nh·∫•t cho item m·ªõi (ƒë·ªÉ qu·∫£n l√Ω d√¢y d·∫´n sau n√†y)
                    draggedItemCopy.dataset.itemId = generateUUID();
                    
                    dropZone.appendChild(draggedItemCopy);

                    // C·∫¨P NH·∫¨T: G·ªçi h√†m snap T·ªß ƒëi·ªán/Pin m·∫∑t tr·ªùi
                    updateAllSnapPositions();
                    
                    // C·∫¨P NH·∫¨T TO√ÄN B·ªò M√î PH·ªéNG
                    updateAllSimulationStates();
                }
                draggedItemCopy = null;
            }
            
            // TR∆Ø·ªúNG H·ª¢P 3: TH·∫¢ C√îNG C·ª§ ƒêANG DI CHUY·ªÇN (MOVE/DELETE)
            else if (draggedItem) {
                draggedItem.classList.remove('dragging'); // X√≥a class dragging
                
                if (isOverToolBox && isDragging) { // Ch·ªâ x√≥a n·∫øu th·ª±c s·ª± k√©o
                    const removedItemId = draggedItem.dataset.itemId;
                    
                    // X√ìA D√ÇY D·∫™N LI√äN QUAN
                    if (removedItemId) {
                        removeWires(removedItemId);
                    }

                    draggedItem.remove(); 
                    
                } else if (isDragging) { // Ch·ªâ th·ª±c hi·ªán logic th·∫£ n·∫øu th·ª±c s·ª± k√©o
                    // Reset z-index ch√≠nh x√°c khi th·∫£
                    if (draggedItem.dataset.tool === 'house') {
                        draggedItem.style.zIndex = 5; 
                    } else if (draggedItem.dataset.tool === 'solar-panel') {
                        draggedItem.style.zIndex = 8;
                    } else {
                        draggedItem.style.zIndex = 20; 
                    }

                    // C·∫≠p nh·∫≠t d√¢y d·∫´n l·∫ßn cu·ªëi khi th·∫£
                    if (draggedItem.dataset.itemId) {
                        updateConnectedWires(draggedItem.dataset.itemId);
                    }
                    
                    // C·∫¨P NH·∫¨T: G·ªçi h√†m snap khi di chuy·ªÉn Ng√¥i nh√†
                    if (draggedItem.dataset.tool === 'house') {
                        updateAllSnapPositions();
                    }
                }
                // N·∫øu kh√¥ng k√©o (isDragging l√† false), th√¨ ƒë√¢y l√† m·ªôt c√∫ click
                // v√† kh√¥ng c·∫ßn l√†m g√¨ ·ªü ƒë√¢y c·∫£ (click ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω)
                
                // C·∫¨P NH·∫¨T TO√ÄN B·ªò M√î PH·ªéNG (sau khi x√≥a ho·∫∑c th·∫£)
                updateAllSimulationStates();
                draggedItem = null; 
            }
            
            // S·ª¨A L·ªñI CLICK: Reset tr·∫°ng th√°i k√©o
            isDragging = false;
            isPotentialDrag = false;
        });
        
        // KH·ªûI CH·∫†Y M√î PH·ªéNG L·∫¶N ƒê·∫¶U
        updateAllSimulationStates();

    </script>
</body>
</html>

